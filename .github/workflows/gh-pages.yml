name: ghPages

on:
  push:
    branches:
      - feature

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Use Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'

      - name: Add README
        run: |
          cp -f ./readme.md ./static/README.md

      - name: Build Project
        run: |
          npm install
          npm run build

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3 # 使用第三方 Action 把构建完成的 Artifact 部署到指定分支
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          publish_branch: master

      - name: ssh deploy
        # You may pin to the exact commit or the version.
        # uses: easingthemes/ssh-deploy@01a39e33483634cbd7ac99020c55b72ca7f098fe
        uses: easingthemes/ssh-deploy@v5.0.3
        with:
          # Private key part of an SSH key pair
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          # Remote host
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          # Remote user
          REMOTE_USER: 'root'
          # Remote port
          REMOTE_PORT: # optional, default is 22
          # Source directory, path relative to `$GITHUB_WORKSPACE` root, eg: `dist/`
          SOURCE: 'build'
          # Target directory
          TARGET: '/www/wwwroot/wiki.lihx.top'
          # Arguments to pass to rsync
          ARGS: '-avzr --delete ' # optional, default is -rlgoDzvc -i
          # An array of ssh arguments, they must be prefixed with -o and separated by a comma, for example: -o SomeArgument=no, -o SomeOtherArgument=5
          # SSH_CMD_ARGS: # optional, default is -o StrictHostKeyChecking=no
          # # paths to exclude separated by `,`, ie: `/dist/, /node_modules/`
          # EXCLUDE: # optional, default is
          # # Script to run on host machine before rsync
          # SCRIPT_BEFORE: # optional, default is
          # # If not an empty string, the action will fail if the before script fails. Note: The string 'false' will be treated as true
          # SCRIPT_BEFORE_REQUIRED: # optional, default is
          # # Script to run on host machine after rsync
          # SCRIPT_AFTER: # optional, default is
          # # If not an empty string, the action will fail if the after script fails. Note: The string 'false' will be treated as true
          # SCRIPT_AFTER_REQUIRED: # optional, default is
